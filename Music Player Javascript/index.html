<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/4074b6dd70.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="./styles/style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-storage.js"></script>
  <title>Audio Player</title>
</head>

<body>
  <div class="app">
    <div class="connect-popup">
      <div class="alert-message popup-section">
        <i class="fas fa-times"></i>
        <div></div>
      </div>
      <div class="signup-form popup-section">
        <i class="fas fa-times"></i>
        <h3>Sign Up</h3>
        <form action="">
          <div>
            <label for="">Email:</label>
            <input type="email" id="signup-email" required />
          </div>
          <div>
            <label for="signup-password">Password:</label>
            <input type="password" id="signup-password" required />
          </div>
          <div>
            <a href="#" id="login-link">or Log in</a>
            <button type="submit">Sign up</button>
          </div>
        </form>
      </div>
      <div class="login-form popup-section">
        <i class="fas fa-times"></i>
        <h3>Log In</h3>
        <form action="">
          <div>
            <label for="">Email:</label>
            <input type="email" id="login-email" required />
          </div>
          <div>
            <label for="signup-password">Password:</label>
            <input type="password" id="login-password" required />
          </div>
          <div>
            <a href="#" id="signup-link">or Sign up</a>
            <button type="submit">Log in</button>
          </div>
        </form>
      </div>
      <div class="logout-form popup-section">
        <i class="fas fa-times"></i>

        <form action="">
          <i class="fas fa-times"></i>
          <button type="submit">Log out</button>
        </form>
      </div>
      <div class="add-song-form popup-section">
        <i class="fas fa-times"></i>

        <h3>Add Song To Your library:</h3>
        <form action="">
          <div>
            <label for="add-song-btn">Choose File:</label>
            <input type="file" id="add-song-input" accept="audio/*" required />
          </div>
          <div>
            <label for="add-song-name">Song Name:</label>
            <input type="text" id="add-song-name" required />
          </div>
          <div>
            <label for="add-song-artist">Artist Name:</label>
            <input type="text" name="" id="add-song-artist" required />
          </div>
          <div>
            <button>upload</button>
          </div>
        </form>
      </div>
    </div>
    <nav>
      <span id="connect-link">Connect</span>
      <span id="library-link">Library</span>
    </nav>
    <div class="song-info">
      <img src="https://chillhop.com/wp-content/uploads/2020/09/0255e8b8c74c90d4a27c594b3452b2daafae608d-1024x1024.jpg"
        alt="" />
      <div>
        <h2>Quran</h2>
        <h3>Hakim Omari</h3>
      </div>
    </div>
    <div class="player">
      <div>
        <input type="range" />
        <div></div>
      </div>
      <span>start</span>
      <span>end</span>
    </div>
    <div class="player-control">
      <i class="fas fa-backward" id="backward"></i>
      <i class="fas fa-play" id="play-pause"></i>
      <i class="fas fa-forward" id="forward"></i>
    </div>
    <div class="sound-control">
      <i class="fas fa-volume-down"></i>
      <input type="range" max="100" step="1" />
      <i class="fas fa-volume-up"></i>
    </div>
    <audio src="./songs/quran.mp3"></audio>
  </div>
  <div class="library">
    <h2>Library</h2>
    <div class="library-song selected" id="0">
      <img src="https://chillhop.com/wp-content/uploads/2020/09/0255e8b8c74c90d4a27c594b3452b2daafae608d-1024x1024.jpg"
        alt="" />
      <div class="library-song-info">
        <h3>Song 1</h3>
        <h4>Artist 1</h4>
      </div>
    </div>
    <div class="library-song" id="1">
      <img src="https://chillhop.com/wp-content/uploads/2020/07/ef95e219a44869318b7806e9f0f794a1f9c451e4-1024x1024.jpg"
        alt="" />
      <div class="library-song-info">
        <h3>Song 2</h3>
        <h4>Artist 2</h4>
      </div>
    </div>
    <div class="library-song" id="2">
      <img src="https://chillhop.com/wp-content/uploads/2020/07/ff35dede32321a8aa0953809812941bcf8a6bd35-1024x1024.jpg"
        alt="" />
      <div class="library-song-info">
        <h3>Song 3</h3>
        <h4>Artist 3</h4>
      </div>
    </div>
    <div class="library-song" id="3">
      <img src="https://chillhop.com/wp-content/uploads/2020/07/ef95e219a44869318b7806e9f0f794a1f9c451e4-1024x1024.jpg"
        alt="" />
      <div class="library-song-info">
        <h3>Song 4</h3>
        <h4>Artist 4</h4>
      </div>
    </div>
    <div class="library-song" id="4">
      <img src="https://chillhop.com/wp-content/uploads/2020/07/ff35dede32321a8aa0953809812941bcf8a6bd35-1024x1024.jpg"
        alt="" />
      <div class="library-song-info">
        <h3>Song 5</h3>
        <h4>Artist 5</h4>
      </div>
    </div>
    <div class="library-song" id="5">
      <img src="https://chillhop.com/wp-content/uploads/2020/09/0255e8b8c74c90d4a27c594b3452b2daafae608d-1024x1024.jpg"
        alt="" />
      <div class="library-song-info">
        <h3>Song 6</h3>
        <h4>Artist 6</h4>
      </div>
    </div>
    <div class="add-song">Add Song <i class="far fa-plus-square"></i></div>
  </div>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyDrlpoAxibJjGCUbYq8rfBNK7wcjQbzpLg",
      authDomain: "audio-player-1d670.firebaseapp.com",
      projectId: "audio-player-1d670",
      storageBucket: "audio-player-1d670.appspot.com",
      messagingSenderId: "897703865464",
      appId: "1:897703865464:web:cdb889b090895c8aa9918d",
      measurementId: "G-724R4XTJZW",
      storageBucket: "gs://audio-player-1d670.appspot.com",
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    const storageRef = storage.ref();
  </script>
  <!-- <script src="./scripts/songs.js"></script>
    <script src="./scripts/app.js"></script>
    <script src="./scripts/auth.js"></script>
    <script src="./scripts/storage.js"></script> -->
  <script>
    const audio = document.querySelector("audio");
    const cover = document.querySelector(".song-info img");
    const library = document.querySelector(".library");

    const libraryLink = document.getElementById("library-link");
    let librarySongs = Array.from(document.querySelectorAll(".library-song"));
    let playStatus = false;

    libraryLink.addEventListener("click", openLibrary);

    function openLibrary() {
      if (library.classList.contains("library-opened")) {
        library.classList.remove("library-opened");
        libraryLink.classList.remove("library-opened-link");
      } else {
        library.classList.add("library-opened");
        libraryLink.classList.add("library-opened-link");
      }
    }
    librarySongs.forEach((song) => {
      song.addEventListener("click", (e) => {
        librarySongs.forEach((otherSong) => {
          otherSong.classList.remove("selected");
        });
        e.target.classList.add("selected");
        songId = song.id;
        songs.filter((selectedSong) => {
          if (selectedSong.id == song.id) {
            playSong(selectedSong);
          }
        });
      });
    });

    const name = document.querySelector(".song-info h2");
    const artist = document.querySelector(".song-info h3");

    function playSong(song) {
      cover.setAttribute("src", song.cover);
      name.innerText = song.name;
      artist.innerText = song.artist;
      audio.setAttribute("src", song.audio);
      playStatus = false;
      playPause();
    }

    //*player control actions
    //play||pause action
    const playPauseIcon = document.getElementById("play-pause");

    playPauseIcon.addEventListener("click", () => {
      playPause();
    });

    function playPause() {
      if (playStatus === false) {
        playPauseIcon.className = "fas fa-pause";
        audio.play();
        cover.classList.add("playing");
        playStatus = true;
      } else {
        playPauseIcon.className = "fas fa-play";
        audio.pause();
        cover.classList.remove("playing");
        playStatus = false;
      }
    }
    //* sound volume control
    const volume = document.querySelector(".sound-control input");
    volume.addEventListener("change", () => {
      audio.volume = volume.value / 100;
    });

    //*defining audio and song info
    //format current/duration time
    function timeFormat(time) {
      return Math.floor(time / 60) + ":" + ("0" + Math.floor(time % 60)).slice(-2);
    }

    const durationInput = document.querySelector(".player input");
    const currentTime = document.querySelector(".player span");

    audio.addEventListener("loadedmetadata", () => {
      const endTime = document.querySelector(".player span:last-child");
      durationInput.value = audio.currentTime;
      durationInput.setAttribute("max", audio.duration);
      currentTime.innerText = `${timeFormat(audio.currentTime)}`;
      endTime.innerText = `${timeFormat(audio.duration)}`;
    });
    audio.addEventListener("timeupdate", () => {
      durationInput.value = audio.currentTime;
      currentTime.innerText = `${timeFormat(audio.currentTime)}`;
      document.querySelector(".player div div").style.left = `${(audio.currentTime / audio.duration) * 100
        }%
`;
    });

    durationInput.addEventListener("change", () => {
      audio.currentTime = durationInput.value;
    });

    //*skipping back/forward
    const back = document.getElementById("backward");
    const forward = document.getElementById("forward");
    back.addEventListener("click", () => skipSong("backward"));
    forward.addEventListener("click", () => skipSong("forward"));

    audio.addEventListener("ended", () => skipSong("forward"));
    function skipSong(direction) {
      const selectedSong = document.querySelector(".selected");
      selectedSongIndex = librarySongs.indexOf(selectedSong);

      selectedSong.classList.remove("selected");
      if (direction === "backward") {
        previousSong = librarySongs[selectedSongIndex - 1];
        if (librarySongs.indexOf(previousSong) === -1) {
          previousSong = librarySongs[librarySongs.length - 1];
        }
        previousSong.classList.add("selected");
        songs.filter((song) => {
          if (song.id == previousSong.id) {
            playSong(song);
          }
        });
      } else if (direction === "forward") {
        nextSong = librarySongs[selectedSongIndex + 1];

        if (librarySongs.indexOf(nextSong) === -1) {
          nextSong = librarySongs[0];
        }
        nextSong.classList.add("selected");
        songs.filter((song) => {
          if (song.id == nextSong.id) {
            playSong(song);
          }
        });
      }
    }

    const connectLink = document.getElementById("connect-link"),
      logInLink = document.getElementById("login-link"),
      signUpLink = document.getElementById("signup-link"),
      signupForm = document.querySelector(".signup-form"),
      loginForm = document.querySelector(".login-form"),
      logoutForm = document.querySelector(".logout-form"),
      connectPopup = document.querySelector(".connect-popup"),
      crosses = document.querySelectorAll(".connect-popup i"),
      alertMessage = document.querySelector(".alert-message"),
      addSongLink = document.querySelector(".add-song"),
      addSongForm = document.querySelector(".add-song-form");

    crosses.forEach((cross) => {
      cross.addEventListener("click", (e) => {
        connectPopup.style.transform = "translate(-50%, -50%) scale(0)";
      });
    });
    signUpLink.addEventListener("click", (e) => {
      openForm(signupForm);
    });
    logInLink.addEventListener("click", (e) => {
      openForm(loginForm);
    });

    signupForm.addEventListener("submit", (e) => {
      e.preventDefault();
      email = document.getElementById("signup-email").value;
      password = document.getElementById("signup-password").value;
      auth
        .createUserWithEmailAndPassword(email, password)
        .then((cred) => {
          connectPopup.style.transform = "translate(-50%, -50%) scale(0)";
          db.collection("usersSongs").doc(`${cred.user.uid}`).set({
            songs: [],
            songIdCounter: 6,
          });
          //signupForm.childNodes[2].reset();
        })
        .then(() => {
          alertMessage.lastElementChild.innerText = "You signed up!";
          openForm(alertMessage);
          connectPopup.style.transform = "translate(-50%, -50%) scale(1)";
        });
    });

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      email = document.getElementById("login-email").value;
      password = document.getElementById("login-password").value;
      auth
        .signInWithEmailAndPassword(email, password)
        .then((cred) => {
          connectPopup.style.transform = "translate(-50%, -50%) scale(0)";
          console.log(loginForm.childNodes[2]);
        })
        .then(() => {
          alertMessage.lastElementChild.innerText = "You're Logged In!";
          openForm(alertMessage);
          connectPopup.style.transform = "translate(-50%, -50%) scale(1)";
        });
    });

    addSongLink.addEventListener("click", () => {
      openForm(addSongForm);
      connectPopup.style.transform = "translate(-50%, -50%)";
    });

    auth.onAuthStateChanged((user) => {
      if (user) {
        connectLink.innerText = `Log Out`;
        logoutForm.addEventListener("submit", (e) => {
          e.preventDefault();
          auth.signOut();
          connectPopup.style.transform = "translate(-50%, -50%) scale(0)";
          location.reload();
        });
        connectLink.addEventListener("click", (e) => {
          openForm(logoutForm);
          connectPopup.style.transform = "translate(-50%, -50%) scale(1)";
        });
        addSongLink.addEventListener("click", (e) => {
          openForm(addSongForm);
          connectPopup.style.transform = "translate(-50%, -50%) scale(1)";
        });
        addSongForm.addEventListener("submit", (e) => {
          e.preventDefault();
          uploadSongToStorage(user);
        });

        //* Databse Watching
        db.collection("usersSongs")
          .doc(`${user.uid}`)
          .onSnapshot((snapshot) => {
            loadSongsToApp(user);
          });
      } else {
        connectLink.innerText = `Connect`;
        connectLink.addEventListener("click", (e) => {
          openForm(signupForm);
          connectPopup.style.transform = "translate(-50%, -50%) scale(1)";
        });
        addSongLink.addEventListener("click", (e) => {
          alertMessage.lastElementChild.innerText =
            "You Must Be Logged In To Add Song!!";
          openForm(alertMessage);
          connectPopup.style.transform = "translate(-50%, -50%) scale(1)";
        });
      }
    });

    function openForm(section) {
      document.querySelectorAll(".connect-popup .popup-section").forEach((form) => {
        form.style.display = "none";
        form.style.ponterEvents = "none";
      });
      section.style.display = "flex";
      section.style.pointerEvents = "auto";
    }

    function loadSongsToApp(user) {
      db.collection("usersSongs")
        .doc(`${user.uid}`)
        .get()
        .then((doc) => {
          usersSongs = doc.data().songs;
          usersSongs.forEach((song) => {
            songs.push(song);
          });
        })
        .then(() => {
          createLibrarySong(songs);
        });
    }
    function createLibrarySong(songs) {
      songs.forEach((song) => {
        librarySong = document.createElement("div");
        librarySong.className = "library-song";
        librarySong.id = `${song.id}`;
        librarySong.innerHTML = `<img
          src="${song.cover}"
          alt=""
        />
        <div class="library-song-info">
          <h3>${song.name}</h3>
          <h4>${song.artist}</h4>
        </div>`;
        if (!document.getElementById(`${song.id}`)) {
          library.insertBefore(librarySong, library.lastElementChild);
          librarySongs.push(librarySong);
          librarySongs.forEach((song) => {
            song.addEventListener("click", (e) => {
              librarySongs.forEach((otherSong) => {
                otherSong.classList.remove("selected");
              });
              e.target.classList.add("selected");
              songId = song.id;
              songs.filter((selectedSong) => {
                if (selectedSong.id == song.id) {
                  playSong(selectedSong);
                }
              });
            });
          });
        }
      });
    }

    let songs = [
      {
        name: "Quran",
        cover:
          "https://chillhop.com/wp-content/uploads/2020/09/0255e8b8c74c90d4a27c594b3452b2daafae608d-1024x1024.jpg",
        artist: "Hakim Omari",
        audio: null,
        id: 0,
      },
      {
        name: "Quran1",
        cover:
          "https://chillhop.com/wp-content/uploads/2020/07/ef95e219a44869318b7806e9f0f794a1f9c451e4-1024x1024.jpg",
        artist: "Hakim Omari1",
        audio: null,
        id: 1,
      },
      {
        name: "Quran2",
        cover:
          "https://chillhop.com/wp-content/uploads/2020/07/ff35dede32321a8aa0953809812941bcf8a6bd35-1024x1024.jpg",
        artist: "Hakim Omari2",
        audio: null,
        id: 2,
      },
      {
        name: "Quran3",
        cover:
          "https://chillhop.com/wp-content/uploads/2020/07/ef95e219a44869318b7806e9f0f794a1f9c451e4-1024x1024.jpg",
        artist: "Hakim Omari3",
        audio: null,
        id: 3,
      },
      {
        name: "Quran4",
        cover:
          "https://chillhop.com/wp-content/uploads/2020/07/ff35dede32321a8aa0953809812941bcf8a6bd35-1024x1024.jpg",
        artist: "Hakim Omari4",
        audio: null,
        id: 4,
      },
      {
        name: "Quran5",
        cover:
          "https://chillhop.com/wp-content/uploads/2020/09/0255e8b8c74c90d4a27c594b3452b2daafae608d-1024x1024.jpg",
        artist: "Hakim Omari5",
        audio: null,
        id: 5,
      },
    ];
    storageRef
      .child("default")
      .child("quran.mp3")
      .getDownloadURL()
      .then((url) => {
        songs[0].audio = url;
      });

    storageRef
      .child("default")
      .child("quran1.mp3")
      .getDownloadURL()
      .then((url) => {
        songs[1].audio = url;
      });
    storageRef
      .child("default")
      .child("quran2.mp3")
      .getDownloadURL()
      .then((url) => {
        songs[2].audio = url;
      });
    storageRef
      .child("default")
      .child("quran3.mp3")
      .getDownloadURL()
      .then((url) => {
        songs[3].audio = url;
      });
    storageRef
      .child("default")
      .child("quran4.mp3")
      .getDownloadURL()
      .then((url) => {
        songs[4].audio = url;
      });
    storageRef
      .child("default")
      .child("quran5.mp3")
      .getDownloadURL()
      .then((url) => {
        songs[5].audio = url;
      });


    const audioInput = document.getElementById("add-song-input");

    function uploadSongToStorage(user) {
      const audioFile = audioInput.files[0],
        audioName = document.getElementById("add-song-name").value,
        audioArtist = document.getElementById("add-song-artist").value,
        audioType = audioFile.type.slice(6),
        userAudioFilesRef = storageRef.child(`${user.uid}`).child(`${audioName}`);
      userAudioFilesRef.put(audioFile).then(() => {
        userAudioFilesRef
          .getDownloadURL()

          .then((url) => {
            db.collection("usersSongs")
              .doc(`${user.uid}`)
              .get()
              .then((doc) => {
                songIdCounter = doc.data().songIdCounter + 1;
              })
              .then(() => {
                song = {
                  name: audioName,
                  artist: audioArtist,
                  audio: url,
                  id: songIdCounter,
                  cover:
                    "https://chillhop.com/wp-content/uploads/2020/09/0255e8b8c74c90d4a27c594b3452b2daafae608d-1024x1024.jpg",
                };
                db.collection("usersSongs")
                  .doc(`${user.uid}`)
                  .update({
                    songs: firebase.firestore.FieldValue.arrayUnion(song),
                    songIdCounter: songIdCounter,
                  });
                connectPopup.style.transform = "translate(-50%, -50%) scale(0)";
              });
            loginForm.childNodes[2].reset();
          })
          .then(() => {
            alertMessage.lastElementChild.innerText = "Song Aded To Library!!";
            openForm(alertMessage);
            connectPopup.style.transform = "translate(-50%, -50%) scale(1)";
          });
      });
    }

  </script>
</body>

</html>